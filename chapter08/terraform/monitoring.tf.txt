resource "helm_release" "kube_prometheus_stack" {
  name             = "prometheus"
  namespace        = "monitoring"
  create_namespace = true

  repository = "https://prometheus-community.github.io/helm-charts"
  chart      = "kube-prometheus-stack"
  version    = "48.1.1"

  values = [
    <<-EOF
    prometheus:
      enabled: true
    alertmanager:
      enabled: true

    grafana:
      enabled: true
      adminUser: admin
      adminPassword: prom-operator

      # Provision Prometheus & Loki datasources
      datasources:
        datasources.yaml:
          apiVersion: 1
          datasources:
            - name: Prometheus
              type: prometheus
              access: proxy
              url: http://prometheus-operated.monitoring.svc.cluster.local:9090
              isDefault: true
            - name: Loki
              type: loki
              access: proxy
              url: http://loki.monitoring.svc.cluster.local:3100
              isDefault: false

      sidecar:
        datasources:
          enabled: false
    EOF
  ]
}

resource "helm_release" "loki_stack" {
  name       = "loki"
  namespace  = "monitoring"
  repository = "https://grafana.github.io/helm-charts"
  chart      = "loki-stack"
  version    = "2.10.2"

  depends_on = [
    helm_release.kube_prometheus_stack,
  ]

  values = [
    <<-EOF
    loki:
      enabled: true
      persistence:
        enabled: true
        size: 10Gi
      config:
        table_manager:
          retention_deletes_enabled: true
          retention_period: 168h
        compactor:
          retention_enabled: true

    promtail:
      enabled: true
      config:
        clients:
          - url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push
    EOF
  ]
}
